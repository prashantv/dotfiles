#!/bin/bash
set -euo pipefail

extract_urls() {
  tmux capture-pane -J -p "$@" \
    | grep -E -o -e 'http(s?)://\S+' \
    | awk '!seen[$0]++' \
    || true
}

urls=$(extract_urls)
if [[ -z "$urls" ]]; then
  for lines in 500 5000 99999; do
    urls=$(extract_urls -S "-$lines")
    [[ -n "$urls" ]] && break
  done
fi

if [[ -z "$urls" ]]; then
  tmux display-message "No URLs found"
  exit 0
fi

echo "$urls" \
  | fzf \
    --tac \
    --tmux center,90%,90% \
    --expect=ctrl-y,ctrl-o,enter \
    --select-1 \
    --header 'Enter: open, CTRL-Y: copy, CTRL-O: insert' \
  | {
    read -r key
    case "$key" in
      ctrl-y)
        # copy into OS clipboard + tmux buffer
        tmux load-buffer -w -
        ;;
      ctrl-o)
        # load selected item into tmux buffer for easy re-use and write it out.
        tmux load-buffer -
        tmux paste-buffer -s ' '
        ;;
      *)
        # open using the OS
        read -r arg
        open-os "$arg"
        ;;
      esac
    } || true
